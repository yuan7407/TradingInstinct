# 2026-02-20 工作日志

## 光斑动态化改造

**需求**: index 页面光斑每次固定在左上角，希望随机位置 + 微微浮动 + 跟随滑动方向移动

**改动文件**: `src/pages/index/index.vue`

### 改动内容

1. **Template**: `bg-spot` 和 `picker-spot` 添加 `:style` 绑定动态位置
2. **Data**: 新增 `spotAStyle`, `spotBStyle`, `pickerSpotAStyle`, `pickerSpotBStyle`
3. **Methods**:
   - `_randomizeSpots()` — 主页光斑随机位置 + 随机动画延迟
   - `_randomizePickerSpots()` — 选择器光斑随机位置 + 随机动画延迟
4. **调用时机**: `onReady`, `advanceChart`, `openStockPicker`, `onPickerChange`
5. **CSS**:
   - 移除 `spot-a/spot-b` 硬编码 `top/left/right/bottom`
   - 新增 `@keyframes spot-float-a/b` (8s/10s 周期浮动)
   - 新增 `@keyframes picker-float-a/b` (9s/11s 周期浮动)
   - 方向偏移用 `margin-left/margin-top` (避免与 transform 动画冲突)
   - `transition: top/left 0.8s` 实现位置切换的平滑过渡

### 踩坑

- CSS `@keyframes` 中的 `transform` 会与类选择器的 `transform` 冲突（动画优先级高于普通规则），方向偏移改用 `margin` 解决

---

## 记忆系统构建

**目标**: 参考 Pangan Quant 记忆系统，深度回顾项目全部历史对话（2025.08-2026.02），建立完整多层记忆

### 信息来源
- Claude.ai 对话历史（2025.08-09，~616KB）— 产品起源/设计/实现全过程
- Git 历史（9 commits）— 代码演进
- 当前代码库 — 实际实现状态
- CLAUDE.md / API 规格文档 — 规范定义

### 创建/更新的文件

| 文件 | 行数 | 内容概要 |
|------|------|----------|
| `memory/MEMORY.md` | ~80行 | 重写为完整速查索引 |
| `topics/product-vision.md` | ~80行 | 起源/灵感/定位/6个关键转折 |
| `topics/architecture-decisions.md` | ~55行 | 平台/技术栈/页面架构/模块/Canvas/AI |
| `topics/ui-ux-patterns.md` | ~90行 | 色彩/光斑/卡片/选择器/动画 |
| `topics/game-mechanics.md` | ~95行 | 交互/股票池/仓位/K线/破产/周期 |
| `topics/performance-patterns.md` | ~70行 | 手势/Canvas/CSS动画/帧率 |
| `topics/debugging-history.md` | ~100行 | 16个已解决 Bug 的完整记录 |
| `topics/backend-api.md` | ~50行 | API设计/数据库/端点/协作状态 |
| `topics/deployment-ops.md` | ~45行 | 构建/DevTools/服务器/Git |

### 设计决策
- MEMORY.md 控制在 ~80 行（150行限制），作为快速索引
- 每个 topic 文件 ≤100 行，聚焦单一主题
- 风格对标 Pangan Quant：简洁 bullet point + **bold** 标签
- 与 CLAUDE.md (L0) 互补不重复：规则在 CLAUDE.md，经验在 memory/

---

## 双模式系统实现

- 新手模式 (beginner): 面积线图 + 归一化数据 + 整数股
- 真实模式 (real): 蜡烛图 + 真实价格 + 周期缓存 + 整数股
- `gameMode` 控制渲染分发: beginner→`_renderLineChart`, real→`_renderKlines`

---

## 东方财富 API 接入

- A股/港股从 `dataSource: 'none'` 改为 `dataSource: 'eastmoney'`
- `fetchHistoricalData()` 自动路由: A股/港股走东方财富, 美股/加密走 Massive
- 新增 5 个辅助函数: `detectMarket`, `toEastMoneySecid`, `toEastMoneyKlt`, `parseEastMoneyKlines`, `fetchEastMoneyData`
- 分钟/小时级 klt 自动扩展请求日期 +14天（覆盖春节/国庆长假）
- index.vue 移除 `dataSource === 'none'` 跳过分支，统一走 API 流程

---

## 整数股强制规则

- 修复: real 模式 `budget / currentPrice` 无 Math.floor 导致碎股
- 改为: 所有模式统一 `Math.max(1, Math.floor(budget / currentPrice))`
- 涉及 3 处计算（handleBuy + handleSell 两处做空）+ 2 处显示

---

## 文档整理

- CLAUDE.md: 修正时间周期表（补 1H，删 3M），添加数据源路由表，添加双模式说明
- README.md: 更新至当前状态（东方财富、双模式、整数股）
- memory/MEMORY.md: 合并两个版本为一份规范，同步 git-tracked 和 private 副本
- topic files: 更新 game-mechanics/backend-api/deployment-ops 反映最新变更
