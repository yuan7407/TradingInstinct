# Bug 历史与踩坑记录

格式：**症状** → **原因** → **解决方案**

## 环境与构建

### Puppeteer/Chromium 下载失败
- 症状: `npm install` 卡在 Chromium 下载
- 原因: uni-app 某些依赖间接依赖 Puppeteer，但小程序项目不需要
- 解决: `PUPPETEER_SKIP_DOWNLOAD=true npm install`

### Webpack url-loader 版本冲突
- 症状: 构建报错 url-loader v4 与某些依赖要求的 v5 冲突
- 原因: uni-app 内部锁定的 webpack 版本与某些包不兼容
- 解决: 使用最小依赖集，不额外安装不必要的 loader

### 微信 DevTools 路径错误
- 症状: 微信开发者工具打开后白屏或报错
- 原因: 打开了源码目录而非构建产物
- 解决: 必须选择 `dist/dev/mp-weixin/` 目录

## 游戏逻辑

### 回合计数器 11/10
- 症状: 10 回合游戏显示"第11轮/10轮"
- 原因: 计数器在错误时机递增（先加后判断 vs 先判断后加）
- 解决: 修正为 1-10 的正确范围

### 金币回合间重置
- 症状: 换一只股票后金币从 10000 重新开始
- 原因: 切换股票时 `totalAsset` 被重置为初始值
- 解决: 金币状态在回合切换中持久化继承

### initGame() 重复定义
- 症状: 某些游戏初始化逻辑不生效
- 原因: methods 中存在两个同名 `initGame()` 方法，后者覆盖前者
- 解决: 删除重复定义，合并逻辑到单一方法

### 异常收益 >100%
- 症状: 单回合收益率出现不合理的大数值
- 原因: 大空仓计算逻辑有误（空仓收益计算公式错误）
- 解决: 添加 DEBUG 日志捕获，修正空仓收益计算

## K线与数据

### K线段不连续
- 症状: 每个回合的 K线是独立片段，看不到行情全貌
- 原因: 每回合随机选取孤立的 K线段
- 解决: 改为连续 K线序列，支持水平回溯查看历史

### K线数据不足导致图表卡住
- 症状: 某些股票 K线数据点太少，图表渲染失败
- 原因: API 返回的数据 <200 点（小盘股/新上市/节假日）
- 解决: 要求最低 200 个数据点，不足则使用 Mock 数据兜底

### DeepSeek 402 余额不足
- 症状: AI 分析返回空白或报错
- 原因: DeepSeek API 账户余额不足（402 Payment Required）
- 解决: 实现本地规则分析降级，DeepSeek 不可用时自动切换

## UI 与交互

### Toast 阻塞手势
- 症状: 弹出 Toast 后无法继续滑动操作
- 原因: uni.showToast 默认 mask=true 阻断触摸事件
- 解决: 改用非模态回调，或 mask=false

### 滑动阈值过高
- 症状: 用户感觉滑动不灵敏，需要很大幅度才触发
- 原因: 初始阈值设为 50px
- 解决: 降低到 30px

### 触摸事件冲突导致页面滚动
- 症状: 在 K线卡片上滑动时整个页面跟着滚动
- 原因: touchmove 事件冒泡到页面
- 解决: `@touchmove.stop.prevent` 阻止冒泡和默认行为

### UI 内容溢出右边缘
- 症状: result 结算页部分内容超出屏幕右侧
- 原因: 某些元素宽度计算未考虑 padding/margin
- 解决: 添加 `overflow: hidden` 或修正布局计算

## Canvas

### Canvas 1.0 性能差
- 症状: K线图渲染卡顿，帧率低
- 原因: 使用旧版 Canvas 1.0 API
- 解决: 升级到 Canvas 2D API（`type="2d"`）

### Canvas 初始化尺寸异常
- 症状: Canvas 绘制内容挤在左上角小区域
- 原因: selector query 返回的尺寸 <300x150（时序问题，DOM 未就绪）
- 解决: 检测异常尺寸后使用 CSS 估算降级（`windowWidth * 0.9`）

## CSS 动画

### transform 动画冲突
- 症状: 光斑浮动动画启动后，滑动方向偏移不生效
- 原因: `@keyframes` 中的 `transform` 覆盖了类选择器的 `transform`
- 解决: 方向偏移改用 `margin-left` / `margin-top`
- 教训: **CSS 动画属性与普通规则同名时，动画优先级更高**
