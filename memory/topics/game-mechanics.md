# 游戏机制详解

## 核心交互映射

| 手势 | 动作 | 触发条件 | 视觉反馈 |
|------|------|----------|----------|
| 右滑 | 买入（做多/加仓） | 水平>30px | 卡片右倾8° + 绿色背景 |
| 左滑 | 卖出（平多/做空） | 水平>30px | 卡片左倾8° + 红色背景 |
| 上滑 | 换股 | 垂直>30px | 卡片上移 + 打开选择器 |
| 下滑 | 跳过（不操作） | 垂直>30px | 卡片下移 + 推进K线 |
| 长按600ms | 触发2X | 按住>600ms | 倾斜加大到14° + 2X标签 |

### 2X 降级机制
- 长按触发 2X 后，如果水平距离回到 <50px → 自动降级为 1X
- 降级时重启长按计时器，需再次达到 600ms 才能重新触发 2X

### Axis 锁定
- touchmove 首次移动 >10px 时判定为水平/垂直方向
- 判定后锁定 `_axis`，后续不再重判（避免斜滑误操作）

## 股票池

### 规模：58只
- 美股: 28只（NVDA/AAPL/TSLA/GME/MSFT/AMZN/META... 含科技/金融/能源/消费）
- 加密: 3只（BTC/ETH/DOGE）
- A股: 15只（茅台/宁德/比亚迪/平安... 覆盖白酒/新能源/金融/科技）
- 港股: 12只（腾讯/小米/美团/阿里... 互联网+消费+金融）

### 市场规则（MARKET_RULES）
- 美股: 可做空
- 加密: 可做空
- A股: **禁止做空**（符合真实市场规则）
- 港股: **禁止做空**

### 股票选择
- 随机不重复选择，用完所有 58 只后重置
- 缓存机制: localStorage 存储已用列表 + K线数据缓存

## 仓位系统

### 资产参数
- 初始金币: 10,000（`GAME_CONFIG.initialAsset`）
- 破产线: 50 金币（`GAME_CONFIG.minAsset`）

### 交易仓位
- 1X: 当前资产的 10%（`tradeRiskPercent: 0.10`）
- 2X: 当前资产的 20%（长按触发）
- **整数股**: `Math.max(1, Math.floor(budget / currentPrice))`，所有模式/市场统一，禁止小数股
- 手续费: 0.1%（`commissionRate: 0.001`），最低 1 金币

### 金币继承
- 回合间金币持久化，不重置（曾出 bug 重置过，已修复）
- 通过 URL 参数或 localStorage 在页面间传递

## K线推进机制

### 波动率自适应
- 基础推进: 3-8 根 K线（根据当前波动率动态调整）
- 高波动: 少推进（让用户看到变化）
- 低波动: 多推进（避免无聊等待）
- jitter: ±1-2 根随机偏移

### 可见区域
- 屏幕显示: 30 根 K线（`visibleKlines: 30`）
- 总数据: 1000 根（`klineLength: 1000`）
- 支持水平回溯查看历史 K线

## 时间周期

| Key | 标签 | K线间隔 | 请求范围 | 最大数据点 | 定位 |
|-----|------|---------|----------|-----------|------|
| 1H | 1时 | 1分钟 | 7天 | 60 | 超短线 |
| 1D | 1日 | 5分钟 | 3天 | 78 | 日内交易 |
| 1W | 1周 | 30分钟 | 21天 | 140 | 短线波段 |
| 1M | 1月 | 1小时 | 3个月 | 180 | 波段交易 |
| 1Y | 1年 | 日K | 1年 | 252 | 长期投资 |
| ALL | 全部 | 周K | 5年 | 260 | 历史全貌 |

- 默认周期: `1M`
- 切换方式: 双指缩放手势
- 切换时: 无缝保持当前持仓状态

## 破产机制
- 触发条件: 资产 < 50 金币
- 等待复活: 递增倒计时（15s / 30s / 45s / 60s）
- 跳过等待: 分享到微信可跳过倒计时

## 数据源与降级链
1. 优先: API 获取真实历史 K线
   - 美股/加密: Massive/Polygon API（需 API Key）
   - A股/港股: 东方财富 HTTP API（免费，无需 Key）
   - `fetchHistoricalData()` 根据 symbol 自动路由
2. 降级: 本地缓存（localStorage）
3. 兜底: Mock 生成随机 K线（`generateMockData()`）
